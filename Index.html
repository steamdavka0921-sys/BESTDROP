<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BEST DROP - GLOBAL VERSION</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --bg: #0b1016; --card: #1a2028; --primary: #ffb703; --border: #2d3436; --blue: #4b69ff; --red: #ff4b4b; --green: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background: var(--bg); color: white; padding-bottom: 90px; }
        .container { padding: 15px; max-width: 1000px; margin: auto; }
        .hidden { display: none !important; }

        /* Header */
        .header { background: var(--card); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .balance-box { display: flex; align-items: center; background: #000; border: 1px solid var(--primary); border-radius: 20px; padding: 2px 12px; cursor: pointer; }
        .add-icon { color: white; font-size: 18px; border-right: 1px solid var(--primary); padding-right: 8px; font-weight: bold; }
        .balance-val { color: var(--primary); font-weight: 700; margin-left: 8px; }
        .login-btn-top { background: var(--primary); color: #000; padding: 6px 15px; border-radius: 20px; font-weight: 700; cursor: pointer; border: none; }

        /* Grid */
        .cat-title { color: var(--primary); font-size: 1.2rem; margin: 25px 0 10px 0; border-left: 4px solid var(--primary); padding-left: 10px; text-transform: uppercase; }
        .items-grid { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 769px) { .items-grid { grid-template-columns: repeat(4, 1fr); } }

        /* Card */
        .item-card { background: #12161d; padding: 10px; border-radius: 8px; border-bottom: 3px solid var(--blue); text-align: center; }
        .item-card img { width: 100%; height: auto; max-height: 110px; object-fit: contain; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: #1a1f29; display: flex; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .btn-main { background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: 700; width: 100%; cursor: pointer; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 onclick="location.reload()">BEST<span style="color:var(--primary)">DROP</span></h2>
        <div id="header-auth"></div>
    </div>

    <div class="container">
        <div id="home-sec"><div id="dynamic-content">Connecting to Server...</div></div>
        
        <div id="profile-sec" class="hidden">
            <div style="text-align:center; padding:20px; background:var(--card); border-radius:15px;">
                <h3 id="p-name">Loading Profile...</h3>
                <div id="auth-buttons" style="margin-top:10px;"></div>
            </div>
            <div class="cat-title">Inventory</div>
            <div id="inv-list" class="items-grid"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')">üè†<p>Home</p></div>
        <div class="nav-item" onclick="showPage('profile')">üë§<p>Profile</p></div>
    </nav>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { 
            apiKey: "AIzaSyA7jQ9vtZPmxhJQNYO6Ebrnhj2_QlklMTI", 
            authDomain: "clean-5ae13.firebaseapp.com", 
            projectId: "clean-5ae13", 
            storageBucket: "clean-5ae13.firebasestorage.app", 
            appId: "1:78759275410:web:caf4dae29260d3a5d52f4b" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let steamID = localStorage.getItem('steamID');
        let userData = { balance: 0.00, inventory: [] };

        // --- AUTH & SYNC ---
        async function syncUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('steamid');
            
            if (idFromUrl) {
                steamID = idFromUrl;
                localStorage.setItem('steamID', idFromUrl);
                // URL-–∞–∞—Å steamid-–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö
                window.history.replaceState({}, document.title, window.location.origin);
            }

            if (!steamID) {
                renderAuthUI(false);
                return;
            }

            const userRef = db.collection('users').doc(steamID);

            // 1. –•—ç—Ä—ç–≥–ª—ç–≥—á –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–∞–¥ –±–∞–π—Ö–≥“Ø–π –±–æ–ª –®–£–£–î “Ø“Ø—Å–≥—ç—Ö
            try {
                const doc = await userRef.get();
                if (!doc.exists()) {
                    console.log("Creating new user in Firestore...");
                    await userRef.set({
                        balance: 0.00,
                        inventory: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Firestore Write Error: ", e);
                alert("Firestore Error! Check your Database Rules.");
            }

            // 2. Real-time –°–æ–Ω—Å–æ—Ö
            userRef.onSnapshot(doc => {
                if (doc.exists()) {
                    userData = doc.data();
                    renderAuthUI(true);
                    renderInv();
                }
            });
        }

        function renderAuthUI(isLoggedIn) {
            const header = document.getElementById('header-auth');
            const pName = document.getElementById('p-name');
            const pBtns = document.getElementById('auth-buttons');

            if (isLoggedIn) {
                header.innerHTML = `
                    <div class="balance-box">
                        <div class="add-icon">+</div>
                        <div class="balance-val">$${Number(userData.balance || 0).toFixed(2)}</div>
                    </div>`;
                pName.innerText = "Steam ID: " + steamID;
                pBtns.innerHTML = `<button class="btn-main" style="background:var(--red); color:white;" onclick="logout()">Logout</button>`;
            } else {
                header.innerHTML = `<button class="login-btn-top" onclick="login()">Sign In</button>`;
                pName.innerText = "Not Signed In";
                pBtns.innerHTML = `<button class="btn-main" onclick="login()">Sign In with Steam</button>`;
            }
        }

        function login() { 
            const returnUrl = window.location.origin + "/.netlify/functions/verify";
            window.location.href = `https://steamcommunity.com/openid/login?openid.ns=http://specs.openid.net/auth/2.0&openid.mode=checkid_setup&openid.return_to=${returnUrl}&openid.realm=${window.location.origin}&openid.identity=http://specs.openid.net/auth/2.0/identifier_select&openid.claimed_id=http://specs.openid.net/auth/2.0/identifier_select`;
        }

        function logout() { localStorage.removeItem('steamID'); location.reload(); }

        // --- DATA LOAD (Cases) ---
        async function loadData() {
            try {
                const catsSnap = await db.collection('categories').orderBy('order').get();
                const casesSnap = await db.collection('active_cases').get();
                let allCases = casesSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                let html = '';
                catsSnap.forEach(catDoc => {
                    const filtered = allCases.filter(c => c.categoryId === catDoc.id);
                    if (filtered.length) {
                        html += `<div class="cat-title">${catDoc.data().name}</div><div class="items-grid">`;
                        filtered.forEach(c => html += `<div class="item-card"><img src="${c.bannerImg}"><p>${c.name}</p><b>$${c.price}</b></div>`);
                        html += `</div>`;
                    }
                });
                document.getElementById('dynamic-content').innerHTML = html || "No cases available.";
            } catch (e) {
                document.getElementById('dynamic-content').innerHTML = "Error loading cases: " + e.message;
            }
        }

        function showPage(id) {
            document.getElementById('home-sec').classList.add('hidden');
            document.getElementById('profile-sec').classList.add('hidden');
            document.getElementById(id + '-sec').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function renderInv() {
            const list = document.getElementById('inv-list');
            if(!list) return;
            list.innerHTML = (userData.inventory || []).map(s => `
                <div class="item-card"><img src="${s.img_code}"><p>${s.name}</p><b>$${s.winPrice}</b></div>
            `).join('') || "<p style='grid-column:1/-1; text-align:center;'>Inventory is empty</p>";
        }

        window.onload = () => { syncUser(); loadData(); };
    </script>
</body>
</html>
